<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget & √âconomies ‚Äî Kevin Croy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{
      --bg:#0c1117; --panel:#121826; --muted:#9aa3b2; --text:#e8edf2;
      --outline:rgba(255,255,255,.08); --ring:rgba(46,168,255,.25);
      --green:#22c55e; --blue:#60a5fa; --amber:#f59e0b; --rose:#fb7185; --grey:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0c1117;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:20;background:#0c1117cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--outline)}
    header .bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e}
    h1{font-size:18px;margin:0}
    .badge{border:1px solid var(--outline);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    .spacer{flex:1}
    .btn{background:#111827;border:1px solid var(--outline);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);color:#06240f;border:none;font-weight:700}
    .btn.warn{background:#1f2937;border:1px solid #334155}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 80px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:380px 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--outline);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center;margin-top:8px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:140px;padding:10px;border-radius:10px;border:1px solid var(--outline);background:#0f1522;color:var(--text);outline:none}
    input:focus,select:focus{border-color:#2ea8ff;box-shadow:0 0 0 4px var(--ring)}
    .hr{height:1px;background:var(--outline);margin:10px 0}
    .legend{display:flex;gap:14px;flex-wrap:wrap;margin:6px 0 8px}
    .dotLegend{width:10px;height:10px;border-radius:50%;display:inline-block}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .kpi{background:rgba(255,255,255,.04);border:1px solid var(--outline);border-radius:12px;padding:10px}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:700;margin-top:2px}
    .section{margin-top:10px}
    .secHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--outline);color:var(--muted)}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:1fr 110px 110px 28px;gap:8px;align-items:center}
    .item input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--outline);background:#0f1522;color:var(--text)}
    .delete{background:#1f2937;border:1px solid #334155;color:#fda4af;border-radius:8px;cursor:pointer}
    .addRow{margin-top:8px}
    table{width:100%;border-collapse:collapse}
    thead th{background:rgba(255,255,255,.05);padding:10px;color:#cbd5e1;text-align:left}
    tbody td{border-top:1px solid var(--outline);padding:10px;color:#dbe2ea}
    .tip{font-size:13px;color:#cfe8ff}
    .banner{background:#0b1220;border:1px solid var(--outline);border-radius:10px;padding:8px 10px;color:#cfe8ff;margin-bottom:8px;display:none}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="dot"></div>
    <h1>Budget & √âconomies ‚Äî <strong>Kevin Croy</strong></h1>
    <span class="badge">Fixes</span>
    <span class="badge">Variables</span>
    <span class="badge">Obligatoires</span>
    <div class="spacer"></div>
    <button id="share" class="btn">Partager</button>
    <button id="csv" class="btn primary">Exporter CSV</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div id="banner" class="banner">üí° Si tu ne vois pas de lignes par d√©faut, clique sur <b>‚ÄúEffacer la sauvegarde‚Äù</b> pour repartir d‚Äôun mod√®le pr√©-rempli.</div>
      <div class="row"><label>Revenu net mensuel (‚Ç¨)</label><input id="revenu" type="number" value="2500"></div>
      <div class="row"><label>Taux d‚Äô√©pargne cible (%)</label><input id="tauxEpargne" type="number" value="20"></div>
      <div class="row"><label>Taille du foyer</label>
        <select id="foyer"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
      </div>
      <div class="hr"></div>

      <div class="section">
        <div class="secHead"><h3 style="margin:0">D√©penses fixes</h3><span class="pill">loyer, assurances, abonnements‚Ä¶</span></div>
        <div id="listFixes" class="list"></div>
        <button id="addFixe" class="btn addRow">+ Ajouter une d√©pense fixe</button>
      </div>

      <div class="section">
        <div class="secHead"><h3 style="margin:0">D√©penses variables</h3><span class="pill">courses, sorties, carburant‚Ä¶</span></div>
        <div id="listVariables" class="list"></div>
        <button id="addVariable" class="btn addRow">+ Ajouter une d√©pense variable</button>
      </div>

      <div class="section">
        <div class="secHead"><h3 style="margin:0">Obligatoires</h3><span class="pill">imp√¥ts, remboursements, cantine‚Ä¶</span></div>
        <div id="listOblig" class="list"></div>
        <button id="addOblig" class="btn addRow">+ Ajouter une d√©pense obligatoire</button>
      </div>

      <div class="hr"></div>
      <div class="section">
        <button id="reset" class="btn warn">R√©initialiser (conserver sauvegarde)</button>
        <button id="clear" class="btn warn">Effacer la sauvegarde</button>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="lab">D√©penses fixes</div><div id="k_fixes" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Variables</div><div id="k_variables" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Obligatoires</div><div id="k_oblig" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">√âpargne potentielle</div><div id="k_epargne" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Taux d‚Äô√©pargne</div><div id="k_taux" class="val">‚Äî</div></div>
      </div>

      <div class="legend">
        <span><span class="dotLegend" style="background:var(--green)"></span> Fixes</span>
        <span><span class="dotLegend" style="background:var(--amber)"></span> Variables</span>
        <span><span class="dotLegend" style="background:var(--rose)"></span> Obligatoires</span>
        <span><span class="dotLegend" style="background:var(--blue)"></span> √âpargne</span>
      </div>
      <div style="height:300px"><canvas id="chart"></canvas></div>

      <div class="hr"></div>
      <h3 style="margin:0 0 8px">Opportunit√©s d‚Äô√©conomies (auto)</h3>
      <ul id="tips" class="tip"></ul>

      <div class="hr"></div>
      <h3 style="margin:0 0 8px">Vue d√©taill√©e</h3>
      <div style="overflow:auto">
        <table id="tab">
          <thead><tr><th>Cat√©gorie</th><th>Intitul√©</th><th>Mensuel (‚Ç¨)</th><th>Fixe/Variable/Oblig.</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const KEY='budget-v1';
  function formatEUR(n){ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0); }
  function $(id){ return document.getElementById(id); }

  // Defaults
  const defaults = {
    revenu: 2500, tauxEpargne: 20, foyer: 3,
    fixes: [
      {name:'Loyer / Cr√©dit logement', amount: 950},
      {name:'Assurance habitation', amount: 20},
      {name:'Assurance auto', amount: 55},
      {name:'√âlectricit√© + gaz', amount: 90},
      {name:'Forfaits mobiles', amount: 40},
      {name:'Internet', amount: 30},
      {name:'Abonnements (SVOD, musique‚Ä¶)', amount: 35},
      {name:'Mutuelle sant√©', amount: 45}
    ],
    variables: [
      {name:'Courses', amount: 450},
      {name:'Carburant / Transports', amount: 120},
      {name:'Restaurants / Caf√©s', amount: 120},
      {name:'Loisirs / Sport', amount: 60},
      {name:'Divers', amount: 80}
    ],
    oblig: [
      {name:'Imp√¥t mensuel', amount: 150},
      {name:'Cantine / Cr√®che', amount: 120},
      {name:'Remboursement cr√©dit conso', amount: 90}
    ]
  };

  // Merge saved with defaults safely
  function loadSaved(){
    try { return JSON.parse(localStorage.getItem(KEY)||'null'); } catch(e){ return null; }
  }
  const saved = loadSaved() || {};
  let state = {
    ...defaults,
    ...saved,
    fixes: Array.isArray(saved.fixes) ? saved.fixes : defaults.fixes.slice(),
    variables: Array.isArray(saved.variables) ? saved.variables : defaults.variables.slice(),
    oblig: Array.isArray(saved.oblig) ? saved.oblig : defaults.oblig.slice()
  };

  // Elements
  const lists = { fixes: $('listFixes'), variables: $('listVariables'), oblig: $('listOblig') };
  const banner = $('banner');

  function maybeBanner(){
    const empty = (!state.fixes?.length) && (!state.variables?.length) && (!state.oblig?.length);
    banner.style.display = empty ? 'block' : 'none';
  }

  function renderList(kind){
    if (!Array.isArray(state[kind])) state[kind] = [];
    const container = lists[kind];
    container.innerHTML = '';
    state[kind].forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <input type="text" value="${it.name||''}" placeholder="Intitul√©">
        <input type="number" value="${Number(it.amount||0)}" min="0" step="1">
        <span style="color:#94a3b8;font-size:12px">‚Ç¨/mois</span>
        <button class="delete" title="Supprimer">√ó</button>
      `;
      const inputs = row.querySelectorAll('input');
      const title = inputs[0];
      const amount = inputs[1];
      const del = row.querySelector('.delete');
      title.addEventListener('input', function(e){ it.name = e.target.value; changed(); });
      amount.addEventListener('input', function(e){ it.amount = Number(e.target.value||0); changed(); });
      del.addEventListener('click', function(){ state[kind].splice(idx,1); changed(); renderAll(); });
      container.appendChild(row);
    });
  }

  function addItem(kind, name, amount){
    if (!Array.isArray(state[kind])) state[kind] = [];
    state[kind].push({name: name||'', amount: Number(amount||0)});
    renderList(kind); changed();
  }

  function renderLeft(){
    $('revenu').value = state.revenu;
    $('tauxEpargne').value = state.tauxEpargne;
    $('foyer').value = state.foyer;
    renderList('fixes'); renderList('variables'); renderList('oblig');
    maybeBanner();
  }

  function sum(arr){ return (Array.isArray(arr)?arr:[]).reduce((a,b)=> a + Number(b.amount||0), 0); }
  function compute(){
    const fixes = sum(state.fixes), variables = sum(state.variables), oblig = sum(state.oblig);
    const depenses = fixes + variables + oblig;
    const revenu = Number(state.revenu||0);
    const epargnePot = Math.max(0, revenu - depenses);
    const taux = revenu>0 ? (epargnePot / revenu * 100) : 0;
    return {fixes, variables, oblig, depenses, revenu, epargnePot, taux};
  }

  function renderKPIs(){
    const k = compute();
    $('k_fixes').textContent = formatEUR(k.fixes);
    $('k_variables').textContent = formatEUR(k.variables);
    $('k_oblig').textContent = formatEUR(k.oblig);
    $('k_epargne').textContent = formatEUR(k.epargnePot);
    $('k_taux').textContent = (isFinite(k.taux) ? k.taux.toFixed(1)+' %' : '‚Äî');
  }

  const chart = new Chart($('chart'), {
    type:'doughnut',
    data:{ labels:['Fixes','Variables','Obligatoires','√âpargne'],
      datasets:[{ data:[0,0,0,0], backgroundColor:['#22c55e','#f59e0b','#fb7185','#60a5fa'] }]
    },
    options:{plugins:{legend:{labels:{color:'#dbe2ea'}}}}
  });

  function renderChart(){
    const k = compute();
    chart.data.datasets[0].data = [k.fixes, k.variables, k.oblig, Math.max(0,k.epargnePot)];
    chart.update('none');
  }

  function renderTips(){
    const k = compute();
    const tips = [];
    const bFixes = 0.50 * k.revenu, bVars = 0.30 * k.revenu, bSave = 0.20 * k.revenu;
    if (k.fixes > bFixes) tips.push(`üîß Tes <b>fixes</b> d√©passent 50 % (${formatEUR(k.fixes)} vs ${formatEUR(bFixes)}). Ren√©gocier box/forfaits, assurances, √©nergie, trier abonnements.`);
    if (k.variables > bVars) tips.push(`üçΩÔ∏è Tes <b>variables</b> d√©passent 30 % (${formatEUR(k.variables)} vs ${formatEUR(bVars)}). Liste de courses, plafonds hebdo, batch cooking.`);
    if (k.epargnePot < bSave) tips.push(`üí∞ √âpargne potentielle ${formatEUR(k.epargnePot)} (< ${formatEUR(bSave)} vis√©s). Automatise ${state.tauxEpargne}% le jour de paye.`);
    const sub = (state.fixes||[]).find(x => /abonnements?|netflix|prime|canal|spotify|disney/i.test(x.name||''));
    if (sub && sub.amount >= 25) tips.push(`üì∫ Abonnements √† ${formatEUR(sub.amount)} : partage familial, offres annuelles, mettre en pause 1‚Äì2 mois/12.`);
    const list = document.getElementById('tips');
    list.innerHTML = tips.length ? tips.map(t => `<li>${t}</li>`).join('') : '<li>Aucune alerte ‚Äî budget ok üëå</li>';
  }

  function renderTable(){
    const tbody = document.querySelector('#tab tbody');
    const safe = a => Array.isArray(a)?a:[];
    const row = (cat, it, type) => `<tr><td>${cat}</td><td>${it.name||''}</td><td>${(it.amount||0).toFixed(0)}</td><td>${type}</td></tr>`;
    tbody.innerHTML = [
      ...safe(state.fixes).map(it=>row('Fixe', it, 'Fixe')),
      ...safe(state.variables).map(it=>row('Variable', it, 'Variable')),
      ...safe(state.oblig).map(it=>row('Obligatoire', it, 'Obligatoire')),
    ].join('');
  }

  function renderAll(){ renderKPIs(); renderChart(); renderTips(); renderTable(); }

  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
  function changed(){ save(); maybeBanner(); renderAll(); }

  // Bind inputs
  $('revenu').addEventListener('input', function(e){ state.revenu = Number(e.target.value||0); changed(); });
  $('tauxEpargne').addEventListener('input', function(e){ state.tauxEpargne = Number(e.target.value||0); changed(); });
  $('foyer').addEventListener('change', function(e){ state.foyer = Number(e.target.value); changed(); });
  $('addFixe').addEventListener('click', function(){ addItem('fixes'); });
  $('addVariable').addEventListener('click', function(){ addItem('variables'); });
  $('addOblig').addEventListener('click', function(){ addItem('oblig'); });

  // Reset / Clear
  $('reset').addEventListener('click', function(){ state = JSON.parse(JSON.stringify(defaults)); renderLeft(); changed(); });
  $('clear').addEventListener('click', function(){ localStorage.removeItem(KEY); state = JSON.parse(JSON.stringify(defaults)); renderLeft(); changed(); });

  // Share & CSV
  $('share').addEventListener('click', function(){
    const k = compute();
    const text = `Budget ‚Äî Revenu: ${formatEUR(k.revenu)} | Fixes: ${formatEUR(k.fixes)} | Variables: ${formatEUR(k.variables)} | Obligatoires: ${formatEUR(k.oblig)} | √âpargne: ${formatEUR(k.epargnePot)} (${k.taux.toFixed(1)}%)`;
    if(navigator.share){ navigator.share({text:text}).catch(function(){}); }
    else if(navigator.clipboard){ navigator.clipboard.writeText(text); alert('R√©sum√© copi√© üìã'); }
  });
  $('csv').addEventListener('click', function(){
    const rows = [['Categorie','Intitul√©','Mensuel','Type']];
    (state.fixes||[]).forEach(function(x){ rows.push(['Fixe',x.name,x.amount,'Fixe']); });
    (state.variables||[]).forEach(function(x){ rows.push(['Variable',x.name,x.amount,'Variable']); });
    (state.oblig||[]).forEach(function(x){ rows.push(['Obligatoire',x.name,x.amount,'Obligatoire']); });
    const csv = rows.map(function(r){ return r.join(','); }).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='budget.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  });

  // Initial render after DOM ready
  function renderLeft(){ $('revenu').value = state.revenu; $('tauxEpargne').value = state.tauxEpargne; $('foyer').value = state.foyer; renderList('fixes'); renderList('variables'); renderList('oblig'); maybeBanner(); }
  function init(){ renderLeft(); renderAll(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

})();
</script>
</body>
</html>
